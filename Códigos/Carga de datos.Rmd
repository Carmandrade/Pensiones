---
title: "Datos"
author: "C"
date: "2024-05-01"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(readxl)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(dplyr)
```

```{r, message=FALSE, warning=FALSE}
fondoB <- read_excel("BD Pensionados.xlsx", sheet = "Fondo B", range = cell_cols(1:8))
planilla<-read_excel("BD Pensionados.xlsx", sheet = "Fondo B", range = "K2", col_names = FALSE)
planilla<- planilla$...1

fondoB[] <- lapply(fondoB, function(x) if(is.character(x)) as.factor(x) else x)

fondoB$`Rige de la Pensión`<- as.Date(fondoB$`Rige de la Pensión`)
fondoB$FEC_NAC<- as.Date(fondoB$FEC_NAC)

fondoB<- fondoB %>% 
  mutate(`Rige de la Pensión` = if_else(is.na(`Rige de la Pensión`), 
                                  FEC_NAC + years(65), 
                                  `Rige de la Pensión`))
summary(fondoB)
```

```{r}
data_vejez <- fondoB[fondoB$COD_TIPO_PENSION == "Vejez", ]
data_sucesion <- fondoB[fondoB$COD_TIPO_PENSION == "Sucesión", ]
data_invalidez <- fondoB[fondoB$COD_TIPO_PENSION == "Invalidez", ]
```

# Distribucion por sexo
```{r}
ggplot(fondoB, aes(x = SEXO, fill = COD_TIPO_PENSION)) + 
  geom_bar(position = "dodge", stat = "count") +
   geom_text(stat = 'count', aes(label = after_stat(count)), vjust = -0.5, position = position_dodge(width = 0.9), size = 3) +
  labs(title = "Distribución por sexo",
       x = "Sexo",
       y = "Cantidad") +
  scale_fill_brewer(palette = "Set1") +  
  theme_minimal()
```

```{r}

fondoB<- fondoB%>%
  mutate(edad = interval(start = fondoB$FEC_NAC, end = today()) / years(1)) %>%
  mutate(edad = round(edad, 2))

fondoB<- fondoB%>%
  mutate(antiguedad = interval(start = fondoB$`Rige de la Pensión`, end = today()) / years(1)) %>%
  mutate(antiguedad = round(antiguedad, 2))

fondoB<- fondoB%>%
  mutate(EsperanzaVida = ifelse(SEXO == "F", 79.81 - edad,
                         ifelse(SEXO == "M", 74.42 - edad, NA))) %>% 
  mutate(EsperanzaVida = ifelse(EsperanzaVida<0, 1,EsperanzaVida))


descripcion <- fondoB %>% select(SEXO, MONTO, edad, antiguedad)
summary(descripcion)

```

# Posibles graficos para la edad

```{r}
ggplot(fondoB, aes(x = COD_TIPO_PENSION, y = edad, fill = COD_TIPO_PENSION)) +
  geom_violin(trim = FALSE) +
  labs(title = "Distribución etaria por tipo de pensión",
       x = "Pensión",
       y = "Edad") +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal()
```
```{r}
ggplot(fondoB, aes(x = edad, fill = COD_TIPO_PENSION)) +
  geom_density(alpha = 0.6) +
  labs(title = "Distribución etaria por tipo de pensión",
       x = "Pensión",
       y = "Edad") +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal()
```

```{r}
ggplot(fondoB, aes(x = edad)) +
  geom_histogram(bins = 20, fill = "skyblue", color = "black") +
  facet_wrap(~ COD_TIPO_PENSION) +
  labs(title = "Distribución etaria por tipo de pensión",
       x = "Pensión",
       y = "Edad") +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal()
```



```{r, message=FALSE, warning=FALSE}
fondoB_Act <- read_excel("BD Activos.xlsx", sheet = "Fondo B", range = cell_cols(1:363))
fondoB_Act[] <- lapply(fondoB_Act, function(x) if(is.character(x)) as.factor(x) else x)
```
# Reescribe los nombres de las columnas por las respectivas fechas
```{r}
num_cols <- ncol(fondoB_Act)
fechas <- seq(as.Date("1994-01-01"), by = "month", length.out = num_cols)
nuevos_nombres <- format(fechas)

for (col in 1:ncol(fondoB_Act)) {
  if (col <= 3){
  }
  else {
    colnames(fondoB_Act)[col] <- nuevos_nombres[col]
  }
}


```
# Calcula la edad según la fecha de nacimiento, devuelve gráficos
```{r}
fondoB_Act$Fec.Nac <- ymd(fondoB_Act$Fec.Nac)
fecha_actual <- as.Date("2023-12-31")
fondoB_Act$Edad <- as.numeric(difftime(fecha_actual, fondoB_Act$Fec.Nac, units = "days")) / 365.25


summary(fondoB_Act$Edad)

hist(fondoB_Act$Edad, breaks = 10, main = "Histograma de Edades", xlab = "Edad", ylab = "Frecuencia", col = "lightblue")

edades_mujeres <- fondoB_Act$Edad[fondoB_Act$Sexo == "F"]
edades_hombres <- fondoB_Act$Edad[fondoB_Act$Sexo == "M"]

hist(edades_mujeres, breaks = 10, main = "Histograma de Edades por Sexo", xlab = "Edad", ylab = "Frecuencia", col = "darkblue", ylim = c(0, max(hist(edades_mujeres, breaks = 10)$counts, hist(edades_hombres, breaks = 10)$counts)))
hist(edades_hombres, breaks = 10, add = TRUE, col = "hotpink", density = 20)
legend("topright", legend = c("Mujeres", "Hombres"), fill = c("darkblue", "hotpink"))


boxplot(fondoB_Act$Edad, main = "Diagrama de Caja de Edades", ylab = "Edad")

boxplot(Edad ~ Sexo, data = fondoB_Act, main = "Diagrama de Caja de Edades por Sexo", ylab = "Edad", col = c("darkblue", "hotpink"))


```
# Calcula la antiguedad y grafica la distribucion
```{r}
calcular_antiguedad <- function(fila) {
  primera_fecha <- which.max(fila != 0)[1]
  if (is.na(primera_fecha)) {
    return(NA)  # Si nunca ha pagado, la antigüedad es NA
  } else {
    fecha_inicio <- as.Date(names(fila)[primera_fecha], format = "%Y-%m-%d")
    fecha_actual <- as.Date("2023-12-31")  # Fecha actual
    antiguedad <- as.numeric(difftime(fecha_actual, fecha_inicio, units = "days")) / 365.25
    return(antiguedad)
  }
}

fondoB_Act$Antiguedad <- apply(fondoB_Act[, -c(1:3)], 1, calcular_antiguedad)


summary(fondoB_Act$Antiguedad)

hist(fondoB_Act$Antiguedad, breaks = 10, main = "Histograma de Antigüedad", xlab = "Antigüedad", ylab = "Frecuencia", col = "lightblue")

frecuencias <- hist(fondoB_Act$Antiguedad, breaks = 10, plot = FALSE)$counts
text(x = pretty(range(fondoB_Act$Antiguedad)), y = frecuencias, labels = frecuencias, pos = 3, col = "black")


boxplot(fondoB_Act$Antiguedad, main = "Diagrama de Caja de Edades", ylab = "Antiguedad")


```

# Resumen estadístico de los datos demográficos 
```{r}
columnasDatos <- fondoB_Act[, c("Fec.Nac", "Edad", "Antiguedad", "Sexo")]

summary(columnasDatos)
```
# Gtaficos de sexo
```{r}
tabla_sexo <- table(fondoB_Act$Sexo)
print(tabla_sexo)

barplot(tabla_sexo, main = "Distribución de Género", xlab = "Género", ylab = "Frecuencia", col = "lightblue")


```



